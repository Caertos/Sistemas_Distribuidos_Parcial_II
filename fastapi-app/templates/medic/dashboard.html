{% extends "base.html" %}

{% block title %}Dashboard - Médico{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='css/medic.css') }}">
{% endblock %}

{% block content %}
<div class="medic-dashboard">
    <header class="dashboard-header">
        <h1>Panel de Control - Dr. {{ user.full_name }}</h1>
        <div class="user-info">
            <span>{{ user.full_name }}</span>
            <a href="/auth/logout" class="logout-btn">Cerrar Sesión</a>
        </div>
    </header>

    <div class="dashboard-stats">
        <div class="stat-card">
            <h3>Pacientes Totales</h3>
            <span class="stat-number" id="total-patients">0</span>
        </div>
        <div class="stat-card">
            <h3>Citas Hoy</h3>
            <span class="stat-number" id="todays-appointments">0</span>
        </div>
        <div class="stat-card">
            <h3>Observaciones</h3>
            <span class="stat-number" id="total-observations">0</span>
        </div>
        <div class="stat-card">
            <h3>Reportes</h3>
            <span class="stat-number" id="total-reports">0</span>
        </div>
    </div>

    <div class="dashboard-content">
        <div class="main-actions">
            <div class="action-group">
                <h3>Pacientes</h3>
                <a href="/medic/patients" class="action-btn">Ver Pacientes</a>
                <a href="/medic/patients/new" class="action-btn">Nuevo Paciente</a>
                <a href="/medic/patients/search" class="action-btn">Buscar Paciente</a>
            </div>

            <div class="action-group">
                <h3>Citas Médicas</h3>
                <a href="/medic/appointments" class="action-btn">Ver Citas</a>
                <a href="/medic/appointments/today" class="action-btn">Citas de Hoy</a>
                <a href="/medic/appointments/schedule" class="action-btn">Programar Cita</a>
            </div>

            <div class="action-group">
                <h3>Herramientas Médicas</h3>
                <a href="/medic/tools/bmi-calculator" class="action-btn">Calculadora IMC</a>
                <a href="/medic/tools/gfr-calculator" class="action-btn">Calculadora TFG</a>
            </div>

            <div class="action-group">
                <h3>Reportes y Análisis</h3>
                <a href="/medic/reports" class="action-btn">Reportes Médicos</a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Obtener token de autenticación
    const token = localStorage.getItem('authToken') || getCookie('authToken');
    
    if (!token) {
        console.error('No hay token de autenticación');
        return;
    }
    
    fetch('/medic/api/dashboard-data', {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Error en la respuesta: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.stats) {
            document.getElementById('total-patients').textContent = data.stats.my_patients || 0;
            document.getElementById('todays-appointments').textContent = data.stats.encounters_today || 0;
            document.getElementById('total-observations').textContent = data.stats.pending_results || 0;
            document.getElementById('total-reports').textContent = data.stats.urgent_pending || 0;
        }
    })
    .catch(error => {
        console.error('Error loading dashboard data:', error);
        // Mostrar valores por defecto en caso de error
        document.getElementById('total-patients').textContent = '-';
        document.getElementById('todays-appointments').textContent = '-';
        document.getElementById('total-observations').textContent = '-';
        document.getElementById('total-reports').textContent = '-';
    });
});

// Función helper para obtener cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}