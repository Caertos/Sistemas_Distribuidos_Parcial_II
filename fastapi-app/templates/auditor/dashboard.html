{% extends "base.html" %}

{% block title %}Dashboard de Auditor√≠a{% endblock %}

{% block nav_items %}
<li class="nav-item">
    <a class="nav-link active" href="{{ url_for('dashboard_auditor') }}">
        <i class="bi bi-shield-check"></i> Dashboard
    </a>
</li>
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
        <i class="bi bi-journal-text"></i> Logs del Sistema
    </a>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('auditor_access_logs') }}">
            <i class="bi bi-door-open"></i> Logs de Acceso
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_operation_logs') }}">
            <i class="bi bi-gear"></i> Logs de Operaci√≥n
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_error_logs') }}">
            <i class="bi bi-exclamation-triangle"></i> Logs de Errores
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_all_logs') }}">
            <i class="bi bi-list-ul"></i> Todos los Logs
        </a></li>
    </ul>
</li>
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
        <i class="bi bi-shield-exclamation"></i> Seguridad
    </a>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('auditor_security_events') }}">
            <i class="bi bi-shield-x"></i> Eventos de Seguridad
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_failed_logins') }}">
            <i class="bi bi-person-x"></i> Intentos Fallidos
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_suspicious_activity') }}">
            <i class="bi bi-eye"></i> Actividad Sospechosa
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_security_reports') }}">
            <i class="bi bi-file-earmark-lock"></i> Reportes de Seguridad
        </a></li>
    </ul>
</li>
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
        <i class="bi bi-graph-up"></i> An√°lisis
    </a>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('auditor_user_activity') }}">
            <i class="bi bi-people"></i> Actividad de Usuarios
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_data_access') }}">
            <i class="bi bi-database"></i> Acceso a Datos
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_system_performance') }}">
            <i class="bi bi-speedometer2"></i> Rendimiento del Sistema
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_custom_reports') }}">
            <i class="bi bi-file-earmark-code"></i> Reportes Personalizados
        </a></li>
    </ul>
</li>
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
        <i class="bi bi-check2-square"></i> Compliance
    </a>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('auditor_hipaa_compliance') }}">
            <i class="bi bi-shield-lock"></i> HIPAA Compliance
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_data_retention') }}">
            <i class="bi bi-archive"></i> Retenci√≥n de Datos
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_privacy_audit') }}">
            <i class="bi bi-eye-slash"></i> Auditor√≠a de Privacidad
        </a></li>
        <li><hr class="dropdown-divider"></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_compliance_reports') }}">
            <i class="bi bi-clipboard-check"></i> Reportes de Compliance
        </a></li>
    </ul>
</li>
<li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
        <i class="bi bi-bell"></i> Alertas
    </a>
    <ul class="dropdown-menu">
        <li><a class="dropdown-item" href="{{ url_for('auditor_active_alerts') }}">
            <i class="bi bi-bell-fill"></i> Alertas Activas
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_alert_history') }}">
            <i class="bi bi-clock-history"></i> Historial de Alertas
        </a></li>
        <li><a class="dropdown-item" href="{{ url_for('auditor_alert_config') }}">
            <i class="bi bi-gear"></i> Configuraci√≥n de Alertas
        </a></li>
    </ul>
</li>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard de Auditor√≠a</li>
{% endblock %}

{% block content %}
<!-- Header del Dashboard de Auditor√≠a -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-0">
            <i class="bi bi-shield-check text-warning me-2"></i>
            Dashboard de Auditor√≠a
        </h1>
        <p class="text-muted mb-0">
            Monitoreo completo de seguridad, compliance y actividad del sistema FHIR.
        </p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-warning" data-bs-toggle="modal" data-bs-target="#alertConfigModal">
            <i class="bi bi-bell"></i> Configurar Alertas
        </button>
        <button class="btn btn-warning" onclick="generateSecurityReport()">
            <i class="bi bi-file-earmark-lock"></i> Generar Reporte
        </button>
    </div>
</div>

<!-- Alertas Cr√≠ticas -->
{% if critical_alerts %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <div class="d-flex align-items-center">
                <i class="bi bi-shield-exclamation fs-4 me-3"></i>
                <div>
                    <h5 class="alert-heading mb-1">¬°Alertas Cr√≠ticas de Seguridad!</h5>
                    <ul class="mb-0">
                        {% for alert in critical_alerts %}
                        <li>{{ alert.message }} <small class="text-muted">({{ alert.timestamp.strftime('%H:%M') }})</small></li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>
{% endif %}

<!-- M√©tricas de Auditor√≠a -->
<div class="row g-4 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="metric-card bg-gradient" style="background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);">
            <div class="d-flex align-items-center text-white">
                <div class="flex-grow-1">
                    <div class="metric-value" id="security-events">{{ audit_metrics.security_events_today or 0 }}</div>
                    <div class="metric-label">Eventos de Seguridad Hoy</div>
                    <div class="metric-trend {{ 'trend-up' if audit_metrics.security_trend > 0 else 'trend-down' if audit_metrics.security_trend < 0 else '' }}">
                        <i class="bi bi-{{ 'arrow-up' if audit_metrics.security_trend > 0 else 'arrow-down' if audit_metrics.security_trend < 0 else 'dash' }}"></i> 
                        {{ audit_metrics.security_trend | abs or 0 }}% vs ayer
                    </div>
                </div>
                <div class="ms-3">
                    <i class="bi bi-shield-exclamation display-4 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card bg-gradient" style="background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);">
            <div class="d-flex align-items-center text-white">
                <div class="flex-grow-1">
                    <div class="metric-value" id="failed-logins">{{ audit_metrics.failed_logins_today or 0 }}</div>
                    <div class="metric-label">Intentos de Login Fallidos</div>
                    <div class="metric-trend">
                        <i class="bi bi-person-x"></i> {{ audit_metrics.unique_failed_ips or 0 }} IPs √∫nicas
                    </div>
                </div>
                <div class="ms-3">
                    <i class="bi bi-person-x display-4 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card bg-gradient" style="background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);">
            <div class="d-flex align-items-center text-white">
                <div class="flex-grow-1">
                    <div class="metric-value" id="total-operations">{{ audit_metrics.total_operations_today or 0 }}</div>
                    <div class="metric-label">Operaciones FHIR Hoy</div>
                    <div class="metric-trend">
                        <i class="bi bi-database"></i> {{ audit_metrics.data_access_operations or 0 }} accesos a datos
                    </div>
                </div>
                <div class="ms-3">
                    <i class="bi bi-gear display-4 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6">
        <div class="metric-card bg-gradient" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <div class="d-flex align-items-center text-white">
                <div class="flex-grow-1">
                    <div class="metric-value">{{ audit_metrics.compliance_score or 98 }}%</div>
                    <div class="metric-label">Score de Compliance</div>
                    <div class="metric-trend trend-up">
                        <i class="bi bi-check-circle"></i> {{ audit_metrics.compliance_checks_passed or 45 }}/{{ audit_metrics.total_compliance_checks or 46 }} checks
                    </div>
                </div>
                <div class="ms-3">
                    <i class="bi bi-check2-square display-4 opacity-75"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Actividad del Sistema y Alertas Recientes -->
<div class="row g-4 mb-4">
    <!-- Actividad Reciente del Sistema -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-activity text-warning me-2"></i>
                    Actividad del Sistema en Tiempo Real
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="location.href='{{ url_for('auditor_all_logs') }}'">
                        Ver Todos
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="refreshSystemActivity()">
                        <i class="bi bi-arrow-clockwise"></i> Actualizar
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="system-activity-feed">
                    {% for activity in recent_activities %}
                    <div class="activity-item p-3 border-bottom activity-{{ activity.severity }}">
                        <div class="d-flex align-items-start">
                            <div class="activity-icon me-3">
                                <div class="rounded-circle bg-{{ activity.icon_color }} d-inline-flex align-items-center justify-content-center" 
                                     style="width: 35px; height: 35px;">
                                    <i class="bi bi-{{ activity.icon }} text-white"></i>
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div>
                                        <h6 class="mb-1">{{ activity.event_type }}</h6>
                                        <p class="mb-1 text-muted">{{ activity.description }}</p>
                                        <div class="activity-meta small text-muted">
                                            <i class="bi bi-person me-1"></i>{{ activity.user or 'Sistema' }}
                                            <span class="mx-2">‚Ä¢</span>
                                            <i class="bi bi-geo-alt me-1"></i>{{ activity.ip_address or 'N/A' }}
                                            <span class="mx-2">‚Ä¢</span>
                                            <i class="bi bi-clock me-1"></i>{{ activity.timestamp.strftime('%H:%M:%S') }}
                                        </div>
                                    </div>
                                    <div class="activity-actions">
                                        <button class="btn btn-sm btn-outline-info" onclick="viewActivityDetails('{{ activity.id }}')">
                                            <i class="bi bi-eye"></i>
                                        </button>
                                    </div>
                                </div>
                                {% if activity.additional_data %}
                                <div class="activity-details mt-2 p-2 bg-light rounded">
                                    <small class="text-muted">
                                        <strong>Detalles:</strong> {{ activity.additional_data | truncate(100) }}
                                    </small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-shield-check display-4 text-success mb-3"></i>
                        <p class="text-muted">No hay actividad reciente del sistema</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Panel de Alertas y Estado -->
    <div class="col-lg-4">
        <div class="card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-bell text-danger me-2"></i>
                    Alertas y Estado del Sistema
                </h5>
                <div class="alert-status-indicator">
                    <span class="badge bg-{{ 'danger' if active_alerts_count > 0 else 'success' }} pulse">
                        {{ active_alerts_count or 0 }}
                    </span>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- Alertas Activas -->
                <div class="alerts-section">
                    <div class="section-header p-3 bg-light border-bottom">
                        <h6 class="mb-0">
                            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
                            Alertas Activas ({{ active_alerts | length }})
                        </h6>
                    </div>
                    <div class="alerts-list">
                        {% for alert in active_alerts %}
                        <div class="alert-item p-3 border-bottom alert-{{ alert.severity }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1 text-{{ alert.color }}">{{ alert.title }}</h6>
                                    <p class="mb-1 small text-muted">{{ alert.description }}</p>
                                    <small class="text-muted">
                                        <i class="bi bi-clock me-1"></i>{{ alert.created_at.strftime('%d/%m %H:%M') }}
                                    </small>
                                </div>
                                <div class="alert-actions">
                                    <button class="btn btn-sm btn-outline-{{ alert.color }}" onclick="acknowledgeAlert('{{ alert.id }}')">
                                        <i class="bi bi-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-shield-check text-success fs-4 mb-2"></i>
                            <p class="text-muted mb-0">No hay alertas activas</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Estado de Servicios -->
                <div class="services-status">
                    <div class="section-header p-3 bg-light border-bottom border-top">
                        <h6 class="mb-0">
                            <i class="bi bi-server text-info me-2"></i>
                            Estado de Servicios
                        </h6>
                    </div>
                    <div class="services-list">
                        {% for service in system_services %}
                        <div class="service-item p-3 border-bottom">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ service.name }}</h6>
                                    <small class="text-muted">{{ service.description }}</small>
                                </div>
                                <div class="service-status">
                                    <span class="badge bg-{{ service.status_color }}">
                                        <i class="bi bi-{{ service.status_icon }}"></i>
                                        {{ service.status }}
                                    </span>
                                </div>
                            </div>
                            {% if service.last_check %}
                            <div class="service-meta mt-1">
                                <small class="text-muted">
                                    √öltima verificaci√≥n: {{ service.last_check.strftime('%H:%M:%S') }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="text-center py-3">
                            <i class="bi bi-question-circle text-muted fs-4 mb-2"></i>
                            <p class="text-muted mb-0">Cargando estado de servicios...</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gr√°ficos de An√°lisis y Compliance -->
<div class="row g-4">
    <!-- Gr√°fico de An√°lisis de Seguridad -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-graph-up text-info me-2"></i>
                    An√°lisis de Seguridad y Actividad
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary active" data-period="24h">24h</button>
                    <button class="btn btn-outline-primary" data-period="7d">7d</button>
                    <button class="btn btn-outline-primary" data-period="30d">30d</button>
                </div>
            </div>
            <div class="card-body">
                <canvas id="securityAnalysisChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Panel de Herramientas de Auditor√≠a -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-tools text-warning me-2"></i>
                    Herramientas de Auditor√≠a
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-warning" onclick="generateSecurityReport()">
                        <i class="bi bi-file-earmark-lock"></i> Reporte de Seguridad
                    </button>
                    
                    <button class="btn btn-info" onclick="exportAuditLogs()">
                        <i class="bi bi-download"></i> Exportar Logs
                    </button>
                    
                    <button class="btn btn-success" onclick="runComplianceCheck()">
                        <i class="bi bi-check2-square"></i> Verificar Compliance
                    </button>
                    
                    <button class="btn btn-danger" onclick="location.href='{{ url_for('auditor_security_events') }}'">
                        <i class="bi bi-shield-exclamation"></i> Eventos Cr√≠ticos
                    </button>
                    
                    <hr class="my-3">
                    
                    <h6 class="text-muted mb-3">Accesos R√°pidos</h6>
                    
                    <button class="btn btn-outline-secondary" onclick="location.href='{{ url_for('auditor_user_activity') }}'">
                        <i class="bi bi-people"></i> Actividad de Usuarios
                    </button>
                    
                    <button class="btn btn-outline-secondary" onclick="location.href='{{ url_for('auditor_data_access') }}'">
                        <i class="bi bi-database"></i> Accesos a Datos
                    </button>
                    
                    <button class="btn btn-outline-secondary" onclick="location.href='{{ url_for('auditor_system_performance') }}'">
                        <i class="bi bi-speedometer2"></i> Rendimiento
                    </button>
                </div>
                
                <!-- Estad√≠sticas R√°pidas -->
                <div class="mt-4 pt-3 border-top">
                    <h6 class="text-muted mb-3">Estad√≠sticas del Sistema</h6>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <small>Uptime del Sistema</small>
                        <strong class="text-success">{{ system_stats.uptime or '99.9%' }}</strong>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <small>Usuarios Activos (24h)</small>
                        <strong>{{ system_stats.active_users_24h or 156 }}</strong>
                    </div>
                    
                    <div class="d-flex justify-content-between mb-2">
                        <small>Operaciones FHIR (24h)</small>
                        <strong>{{ system_stats.fhir_operations_24h or 2847 }}</strong>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <small>Espacio de Logs</small>
                        <strong class="text-info">{{ system_stats.log_storage_used or '2.3 GB' }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Configuraci√≥n de Alertas -->
<div class="modal fade" id="alertConfigModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-bell text-warning me-2"></i>
                    Configuraci√≥n de Alertas de Seguridad
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="alertConfigForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Intentos de Login Fallidos</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="failed_login_threshold" value="5" min="1">
                                <span class="input-group-text">intentos</span>
                            </div>
                            <small class="form-text text-muted">Alertar despu√©s de N intentos fallidos</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Operaciones Sospechosas</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="suspicious_ops_threshold" value="100" min="1">
                                <span class="input-group-text">ops/min</span>
                            </div>
                            <small class="form-text text-muted">Alertar por actividad an√≥mala</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Accesos Fuera de Horario</label>
                            <select class="form-select" id="after_hours_alert">
                                <option value="true">Activado</option>
                                <option value="false">Desactivado</option>
                            </select>
                            <small class="form-text text-muted">Alertar por accesos nocturnos</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Errores del Sistema</label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="system_errors_threshold" value="10" min="1">
                                <span class="input-group-text">errores/hora</span>
                            </div>
                            <small class="form-text text-muted">Alertar por errores frecuentes</small>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Tipos de Eventos a Monitorear</label>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="monitor_login" checked>
                                        <label class="form-check-label" for="monitor_login">
                                            Login/Logout
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="monitor_data_access" checked>
                                        <label class="form-check-label" for="monitor_data_access">
                                            Acceso a Datos
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="monitor_admin_actions" checked>
                                        <label class="form-check-label" for="monitor_admin_actions">
                                            Acciones de Admin
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="monitor_data_modifications" checked>
                                        <label class="form-check-label" for="monitor_data_modifications">
                                            Modificaciones de Datos
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="monitor_system_errors" checked>
                                        <label class="form-check-label" for="monitor_system_errors">
                                            Errores del Sistema
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-12">
                            <label class="form-label">Notificaciones</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="email_notifications" checked>
                                        <label class="form-check-label" for="email_notifications">
                                            Notificaciones por Email
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="in_app_notifications" checked>
                                        <label class="form-check-label" for="in_app_notifications">
                                            Notificaciones en la App
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-warning" onclick="saveAlertConfig()">
                    <i class="bi bi-check"></i> Guardar Configuraci√≥n
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar gr√°fico de an√°lisis de seguridad
    initSecurityAnalysisChart();
    
    // Configurar actualizaci√≥n autom√°tica de actividad
    setInterval(refreshSystemActivity, 30000); // Cada 30 segundos
    
    // Inicializar indicadores de estado
    initStatusIndicators();
    
    // Configurar alertas en tiempo real
    setupRealTimeAlerts();
});

function initSecurityAnalysisChart() {
    const ctx = document.getElementById('securityAnalysisChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: {{ security_chart_data.labels | tojsonfilter }},
            datasets: [{
                label: 'Eventos de Seguridad',
                data: {{ security_chart_data.security_events | tojsonfilter }},
                borderColor: '#ffc107',
                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Intentos de Login Fallidos',
                data: {{ security_chart_data.failed_logins | tojsonfilter }},
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Operaciones FHIR',
                data: {{ security_chart_data.fhir_operations | tojsonfilter }},
                borderColor: '#17a2b8',
                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: 'Alertas Generadas',
                data: {{ security_chart_data.alerts | tojsonfilter }},
                borderColor: '#e83e8c',
                backgroundColor: 'rgba(232, 62, 140, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

function initStatusIndicators() {
    // Animar indicadores de estado
    const statusBadges = document.querySelectorAll('.badge.pulse');
    statusBadges.forEach(badge => {
        if (parseInt(badge.textContent) > 0) {
            badge.classList.add('animate-pulse');
        }
    });
}

function setupRealTimeAlerts() {
    // Simular conexi√≥n WebSocket para alertas en tiempo real
    // En producci√≥n, esto se conectar√≠a a un WebSocket real
    setInterval(checkForNewAlerts, 10000); // Cada 10 segundos
}

async function refreshSystemActivity() {
    try {
        const response = await FHIRApp.apiRequest('/api/auditor/activity/recent');
        
        if (response.activities) {
            updateActivityFeed(response.activities);
        }
        
        // Actualizar indicador de √∫ltima actualizaci√≥n
        const updateBtn = document.querySelector('[onclick="refreshSystemActivity()"]');
        if (updateBtn) {
            updateBtn.innerHTML = '<i class="bi bi-check"></i> Actualizado';
            setTimeout(() => {
                updateBtn.innerHTML = '<i class="bi bi-arrow-clockwise"></i> Actualizar';
            }, 2000);
        }
        
    } catch (error) {
        console.error('Error actualizando actividad:', error);
        FHIRApp.showNotification('Error al actualizar actividad del sistema', 'error');
    }
}

function updateActivityFeed(activities) {
    const feedContainer = document.querySelector('.system-activity-feed');
    if (!feedContainer) return;
    
    // Actualizar solo si hay nuevas actividades
    const currentCount = feedContainer.children.length;
    if (activities.length > currentCount) {
        // Hay nuevas actividades
        const newActivities = activities.slice(0, activities.length - currentCount);
        
        newActivities.forEach(activity => {
            const activityElement = createActivityElement(activity);
            feedContainer.insertBefore(activityElement, feedContainer.firstChild);
        });
        
        // Remover actividades antiguas si hay demasiadas
        while (feedContainer.children.length > 20) {
            feedContainer.removeChild(feedContainer.lastChild);
        }
    }
}

function createActivityElement(activity) {
    const div = document.createElement('div');
    div.className = `activity-item p-3 border-bottom activity-${activity.severity}`;
    div.innerHTML = `
        <div class="d-flex align-items-start">
            <div class="activity-icon me-3">
                <div class="rounded-circle bg-${activity.icon_color} d-inline-flex align-items-center justify-content-center" 
                     style="width: 35px; height: 35px;">
                    <i class="bi bi-${activity.icon} text-white"></i>
                </div>
            </div>
            <div class="flex-grow-1">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <h6 class="mb-1">${activity.event_type}</h6>
                        <p class="mb-1 text-muted">${activity.description}</p>
                        <div class="activity-meta small text-muted">
                            <i class="bi bi-person me-1"></i>${activity.user || 'Sistema'}
                            <span class="mx-2">‚Ä¢</span>
                            <i class="bi bi-geo-alt me-1"></i>${activity.ip_address || 'N/A'}
                            <span class="mx-2">‚Ä¢</span>
                            <i class="bi bi-clock me-1"></i>${new Date(activity.timestamp).toLocaleTimeString()}
                        </div>
                    </div>
                    <div class="activity-actions">
                        <button class="btn btn-sm btn-outline-info" onclick="viewActivityDetails('${activity.id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Animar entrada
    div.style.opacity = '0';
    div.style.transform = 'translateX(-20px)';
    setTimeout(() => {
        div.style.transition = 'all 0.3s ease';
        div.style.opacity = '1';
        div.style.transform = 'translateX(0)';
    }, 100);
    
    return div;
}

async function checkForNewAlerts() {
    try {
        const response = await FHIRApp.apiRequest('/api/auditor/alerts/check');
        
        if (response.new_alerts && response.new_alerts.length > 0) {
            response.new_alerts.forEach(alert => {
                if (alert.severity === 'critical') {
                    FHIRApp.showNotification(
                        `üö® ALERTA CR√çTICA: ${alert.title}`,
                        'error',
                        30000
                    );
                } else if (alert.severity === 'warning') {
                    FHIRApp.showNotification(
                        `‚ö†Ô∏è ALERTA: ${alert.title}`,
                        'warning',
                        15000
                    );
                }
            });
            
            // Actualizar contador de alertas
            updateAlertCounter(response.total_active_alerts);
        }
        
    } catch (error) {
        console.error('Error verificando alertas:', error);
    }
}

function updateAlertCounter(count) {
    const alertBadge = document.querySelector('.alert-status-indicator .badge');
    if (alertBadge) {
        alertBadge.textContent = count;
        alertBadge.className = `badge bg-${count > 0 ? 'danger' : 'success'} pulse`;
    }
}

function viewActivityDetails(activityId) {
    location.href = `/auditor/activity/${activityId}`;
}

async function acknowledgeAlert(alertId) {
    try {
        const response = await FHIRApp.apiRequest(`/api/auditor/alerts/${alertId}/acknowledge`, {
            method: 'POST'
        });
        
        if (response.success) {
            // Remover alerta de la lista
            const alertElement = document.querySelector(`[onclick="acknowledgeAlert('${alertId}')"]`).closest('.alert-item');
            if (alertElement) {
                alertElement.style.opacity = '0';
                setTimeout(() => alertElement.remove(), 300);
            }
            
            FHIRApp.showNotification('Alerta reconocida exitosamente', 'success');
        }
        
    } catch (error) {
        console.error('Error reconociendo alerta:', error);
        FHIRApp.showNotification('Error al reconocer alerta', 'error');
    }
}

async function generateSecurityReport() {
    try {
        FHIRApp.showNotification('Generando reporte de seguridad...', 'info');
        
        const response = await fetch('/api/auditor/reports/security', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                period: '30d',
                include_charts: true,
                format: 'pdf'
            })
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `reporte_seguridad_${new Date().toISOString().split('T')[0]}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            FHIRApp.showNotification('üìÑ Reporte generado exitosamente', 'success');
        } else {
            throw new Error('Error al generar el reporte');
        }
        
    } catch (error) {
        console.error('Error generando reporte:', error);
        FHIRApp.showNotification('Error al generar reporte de seguridad', 'error');
    }
}

async function exportAuditLogs() {
    try {
        FHIRApp.showNotification('Exportando logs de auditor√≠a...', 'info');
        
        const response = await fetch('/api/auditor/logs/export', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
            }
        });
        
        if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `audit_logs_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            FHIRApp.showNotification('üìä Logs exportados exitosamente', 'success');
        } else {
            throw new Error('Error al exportar logs');
        }
        
    } catch (error) {
        console.error('Error exportando logs:', error);
        FHIRApp.showNotification('Error al exportar logs', 'error');
    }
}

async function runComplianceCheck() {
    try {
        FHIRApp.showNotification('Ejecutando verificaci√≥n de compliance...', 'info');
        
        const response = await FHIRApp.apiRequest('/api/auditor/compliance/check', {
            method: 'POST'
        });
        
        if (response.success) {
            FHIRApp.showNotification(
                `‚úÖ Compliance check completado: ${response.score}% de cumplimiento`,
                'success',
                10000
            );
            
            // Actualizar m√©trica de compliance
            const complianceValue = document.querySelector('.metric-card .metric-value:last-of-type');
            if (complianceValue) {
                complianceValue.textContent = response.score + '%';
            }
        }
        
    } catch (error) {
        console.error('Error en compliance check:', error);
        FHIRApp.showNotification('Error en verificaci√≥n de compliance', 'error');
    }
}

async function saveAlertConfig() {
    try {
        const formData = {
            failed_login_threshold: document.getElementById('failed_login_threshold').value,
            suspicious_ops_threshold: document.getElementById('suspicious_ops_threshold').value,
            after_hours_alert: document.getElementById('after_hours_alert').value === 'true',
            system_errors_threshold: document.getElementById('system_errors_threshold').value,
            monitor_login: document.getElementById('monitor_login').checked,
            monitor_data_access: document.getElementById('monitor_data_access').checked,
            monitor_admin_actions: document.getElementById('monitor_admin_actions').checked,
            monitor_data_modifications: document.getElementById('monitor_data_modifications').checked,
            monitor_system_errors: document.getElementById('monitor_system_errors').checked,
            email_notifications: document.getElementById('email_notifications').checked,
            in_app_notifications: document.getElementById('in_app_notifications').checked
        };
        
        const response = await FHIRApp.apiRequest('/api/auditor/alerts/config', {
            method: 'POST',
            body: JSON.stringify(formData)
        });
        
        if (response.success) {
            FHIRApp.showNotification('‚úÖ Configuraci√≥n de alertas guardada exitosamente', 'success');
            
            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('alertConfigModal'));
            modal.hide();
        }
        
    } catch (error) {
        console.error('Error guardando configuraci√≥n:', error);
        FHIRApp.showNotification('Error al guardar configuraci√≥n de alertas', 'error');
    }
}
</script>
{% endblock %}