<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Salud - Dashboard del Paciente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="/static/css/patient-dashboard.css" rel="stylesheet">
</head>
<body>
    <!-- Navegación superior -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <button class="btn btn-link sidebar-toggle me-3" id="sidebarToggle">
                <i class="bi bi-list fs-5"></i>
            </button>
            
            <a class="navbar-brand" href="#">
                <i class="bi bi-heart-pulse me-2"></i>
                Portal de Salud
            </a>
            
            <div class="navbar-nav ms-auto">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="bi bi-person-circle me-1"></i>
                        <span id="user-name">Cargando...</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" data-section="perfil">
                            <i class="bi bi-person me-2"></i>Mi Perfil
                        </a></li>
                        <li><a class="dropdown-item" href="#" data-section="configuracion">
                            <i class="bi bi-gear me-2"></i>Configuración
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="logout()">
                            <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                        </a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <nav class="sidebar-nav">
            <button class="nav-link active" data-section="dashboard">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </button>
            <button class="nav-link" data-section="perfil">
                <i class="bi bi-person"></i>
                Mi Perfil
            </button>
            <button class="nav-link" data-section="historia-clinica">
                <i class="bi bi-journal-medical"></i>
                Historia Clínica
            </button>
            <button class="nav-link" data-section="citas">
                <i class="bi bi-calendar-check"></i>
                Citas Médicas
            </button>
            <button class="nav-link" data-section="medicamentos">
                <i class="bi bi-capsule"></i>
                Medicamentos
            </button>
            <button class="nav-link" data-section="resultados">
                <i class="bi bi-clipboard-data"></i>
                Resultados
            </button>
            <button class="nav-link" data-section="alergias">
                <i class="bi bi-exclamation-triangle"></i>
                Alergias
            </button>
            <button class="nav-link" data-section="agendar-cita">
                <i class="bi bi-calendar-plus"></i>
                Agendar Cita
            </button>
            <hr class="my-3">
            <button class="nav-link" onclick="downloadHealthRecord()">
                <i class="bi bi-download"></i>
                Descargar PDF
            </button>
        </nav>
    </div>

    <!-- Contenido principal -->
    <div class="main-content" id="mainContent">
        <!-- Loading State -->
        <div id="loading-state" class="loading-state">
            <div class="custom-spinner mb-3"></div>
            <h5>Cargando información de salud...</h5>
            <p class="text-muted">Por favor espere mientras obtenemos sus datos</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="error-state d-none">
            <div class="d-flex align-items-center">
                <i class="bi bi-exclamation-triangle fs-4 me-3"></i>
                <div>
                    <h6 class="mb-1">Error al cargar los datos</h6>
                    <p class="mb-0" id="error-message">Ocurrió un problema al obtener la información</p>
                </div>
                <button class="btn btn-outline-danger ms-auto" onclick="window.loadDashboard()">
                    <i class="bi bi-arrow-clockwise"></i> Reintentar
                </button>
            </div>
        </div>

        <!-- Dashboard Content -->
        <div id="dashboard-content" class="d-none">
            <!-- Sección Dashboard -->
            <div id="section-dashboard" class="content-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="mb-1">Bienvenido/a, <span id="welcome-name">...</span></h2>
                        <p class="text-muted mb-0">Aquí tienes un resumen de tu información de salud</p>
                    </div>
                    <button class="btn btn-primary" onclick="window.downloadHealthRecord()">
                        <i class="bi bi-download me-2"></i>Descargar Historia PDF
                    </button>
                </div>

                <!-- Métricas de salud -->
                <div class="row mb-4" id="health-metrics">
                    <!-- Las métricas se cargarán dinámicamente -->
                </div>

                <!-- Citas próximas y medicamentos -->
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-check text-primary me-2"></i>
                                    Próximas Citas
                                </h5>
                            </div>
                            <div class="card-body" id="upcoming-appointments">
                                <!-- Las citas se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-capsule text-success me-2"></i>
                                    Medicamentos Recientes
                                </h5>
                            </div>
                            <div class="card-body" id="recent-medications">
                                <!-- Los medicamentos se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Alertas importantes -->
                <div id="important-alerts" class="mb-4" style="display: none;">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Alertas Importantes
                            </h5>
                        </div>
                        <div class="card-body" id="alerts-content">
                            <!-- Las alertas se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección Perfil -->
            <div id="section-perfil" class="content-section d-none">
                <h2 class="mb-4">Mi Perfil</h2>
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Información Personal</h5>
                            </div>
                            <div class="card-body" id="profile-info">
                                <!-- La información del perfil se cargará aquí -->
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Estadísticas</h5>
                            </div>
                            <div class="card-body" id="profile-stats">
                                <!-- Las estadísticas se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección Historia Clínica -->
            <div id="section-historia-clinica" class="content-section d-none">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="mb-0">Historia Clínica</h2>
                    <button class="btn btn-primary" onclick="window.downloadHealthRecord()">
                        <i class="bi bi-download me-2"></i>Descargar PDF
                    </button>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="timeline" id="medical-history-timeline">
                            <!-- El historial médico se cargará aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección Citas -->
            <div id="section-citas" class="content-section d-none">
                <h2 class="mb-4">Citas Médicas</h2>
                
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Citas Programadas</h5>
                            </div>
                            <div class="card-body" id="all-appointments">
                                <!-- Todas las citas se cargarán aquí -->
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">Resumen de Citas</h5>
                            </div>
                            <div class="card-body" id="appointments-summary">
                                <!-- El resumen se cargará aquí -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección Medicamentos -->
            <div id="section-medicamentos" class="content-section d-none">
                <h2 class="mb-4">Medicamentos</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Medicamentos Activos</h5>
                    </div>
                    <div class="card-body">
                        <div class="medication-list" id="all-medications">
                            <!-- Todos los medicamentos se cargarán aquí -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección Resultados -->
            <div id="section-resultados" class="content-section d-none">
                <h2 class="mb-4">Resultados de Laboratorio</h2>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Resultados Recientes</h5>
                    </div>
                    <div class="card-body" id="all-results">
                        <!-- Los resultados se cargarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Sección Alergias -->
            <div id="section-alergias" class="content-section d-none">
                <h2 class="mb-4">Alergias e Intolerancias</h2>
                
                <div class="card">
                    <div class="card-body" id="all-allergies">
                        <!-- Las alergias se cargarán aquí -->
                    </div>
                </div>
            </div>

            <!-- Sección Agendar Cita -->
            <div id="section-agendar-cita" class="content-section d-none">
                <h2 class="mb-4">Agendar Nueva Cita</h2>
                
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="bi bi-calendar-plus text-primary me-2"></i>
                                    Solicitar Cita Médica
                                </h5>
                            </div>
                            <div class="card-body">
                                <!-- Formulario de agendamiento -->
                                <form id="appointmentForm">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="doctorSelect" class="form-label">
                                                <i class="bi bi-person-badge me-1"></i>
                                                Seleccionar Médico *
                                            </label>
                                            <select class="form-select" id="doctorSelect" required>
                                                <option value="">Cargando especialistas...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="appointmentDate" class="form-label">
                                                <i class="bi bi-calendar me-1"></i>
                                                Fecha de la Cita *
                                            </label>
                                            <input type="date" class="form-control" id="appointmentDate" required>
                                        </div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="appointmentTime" class="form-label">
                                                <i class="bi bi-clock me-1"></i>
                                                Hora Preferida *
                                            </label>
                                            <select class="form-select" id="appointmentTime" required>
                                                <option value="">Seleccionar hora</option>
                                                <option value="08:00">08:00 AM</option>
                                                <option value="08:30">08:30 AM</option>
                                                <option value="09:00">09:00 AM</option>
                                                <option value="09:30">09:30 AM</option>
                                                <option value="10:00">10:00 AM</option>
                                                <option value="10:30">10:30 AM</option>
                                                <option value="11:00">11:00 AM</option>
                                                <option value="11:30">11:30 AM</option>
                                                <option value="14:00">02:00 PM</option>
                                                <option value="14:30">02:30 PM</option>
                                                <option value="15:00">03:00 PM</option>
                                                <option value="15:30">03:30 PM</option>
                                                <option value="16:00">04:00 PM</option>
                                                <option value="16:30">04:30 PM</option>
                                                <option value="17:00">05:00 PM</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-6 mb-3">
                                            <label for="appointmentReason" class="form-label">
                                                <i class="bi bi-chat-left-text me-1"></i>
                                                Motivo de la Consulta *
                                            </label>
                                            <select class="form-select" id="appointmentReason" required>
                                                <option value="">Seleccionar motivo</option>
                                                <option value="Consulta general">Consulta general</option>
                                                <option value="Control de rutina">Control de rutina</option>
                                                <option value="Seguimiento de tratamiento">Seguimiento de tratamiento</option>
                                                <option value="Dolor o molestia">Dolor o molestia</option>
                                                <option value="Revisión de exámenes">Revisión de exámenes</option>
                                                <option value="Renovación de recetas">Renovación de recetas</option>
                                                <option value="Segunda opinión">Segunda opinión</option>
                                                <option value="Otros">Otros (especificar en notas)</option>
                                            </select>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="appointmentNotes" class="form-label">
                                            <i class="bi bi-journal-text me-1"></i>
                                            Notas Adicionales
                                        </label>
                                        <textarea class="form-control" id="appointmentNotes" rows="3" 
                                                placeholder="Describe brevemente tus síntomas o cualquier información adicional que consideres importante..."></textarea>
                                        <div class="form-text">
                                            <i class="bi bi-info-circle me-1"></i>
                                            Esta información ayudará al médico a prepararse mejor para tu consulta.
                                        </div>
                                    </div>
                                    
                                    <div class="alert alert-info">
                                        <i class="bi bi-info-circle me-2"></i>
                                        <strong>Importante:</strong> 
                                        <ul class="mb-0 mt-2">
                                            <li>Las citas están sujetas a disponibilidad del médico</li>
                                            <li>Recibirás confirmación en las próximas 24 horas</li>
                                            <li>Puedes cancelar o reprogramar hasta 24 horas antes</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                        <button type="button" class="btn btn-outline-secondary me-md-2" onclick="window.showSection('citas')">
                                            <i class="bi bi-arrow-left me-1"></i>
                                            Volver a Citas
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-calendar-check me-1"></i>
                                            Agendar Cita
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="bi bi-info-circle text-info me-2"></i>
                                    Información Útil
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <h6 class="text-primary">
                                        <i class="bi bi-clock me-1"></i>
                                        Horarios de Atención
                                    </h6>
                                    <p class="small mb-0">
                                        <strong>Lunes a Viernes:</strong> 8:00 AM - 5:00 PM<br>
                                        <strong>Sábados:</strong> 8:00 AM - 12:00 PM<br>
                                        <strong>Domingos:</strong> Cerrado
                                    </p>
                                </div>
                                
                                <div class="mb-3">
                                    <h6 class="text-success">
                                        <i class="bi bi-telephone me-1"></i>
                                        Contacto de Emergencia
                                    </h6>
                                    <p class="small mb-0">
                                        Para urgencias médicas:<br>
                                        <strong>Tel:</strong> (555) 123-4567<br>
                                        <strong>WhatsApp:</strong> (555) 987-6543
                                    </p>
                                </div>
                                
                                <div class="mb-3">
                                    <h6 class="text-warning">
                                        <i class="bi bi-exclamation-triangle me-1"></i>
                                        Política de Cancelación
                                    </h6>
                                    <p class="small mb-0">
                                        • Cancela con 24h de anticipación<br>
                                        • 3 cancelaciones tardías = restricción temporal<br>
                                        • No-show: posible cargo administrativo
                                    </p>
                                </div>
                                
                                <div class="alert alert-light">
                                    <h6 class="text-primary">
                                        <i class="bi bi-heart-pulse me-1"></i>
                                        Tu Salud es Prioridad
                                    </h6>
                                    <p class="small mb-0">
                                        No dudes en agendar una cita si tienes alguna preocupación de salud. 
                                        La prevención es la mejor medicina.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Script inline para transferir token de cookies a localStorage -->
    <script>
        // Ejecutar antes de cargar el dashboard principal
        (function() {
            try {
                // Buscar token en cookies
                const cookies = document.cookie.split(';');
                const authCookie = cookies.find(cookie => cookie.trim().startsWith('auth_token='));
                
                if (authCookie) {
                    // Extraer el valor completo del token
                    let token = authCookie.substring(authCookie.indexOf('=') + 1);
                    
                    // Limpiar comillas
                    if (token) {
                        token = token.trim();
                        if ((token.startsWith('"') && token.endsWith('"')) || 
                            (token.startsWith("'") && token.endsWith("'"))) {
                            token = token.slice(1, -1);
                        }
                    }
                    
                    // Asegurar prefijo FHIR- sin duplicar
                    if (token && !token.startsWith('FHIR-')) {
                        token = `FHIR-${token}`;
                    }
                    
                    // Validar y guardar token
                    if (token && token.startsWith('FHIR-')) {
                        try {
                            const base64Token = token.substring(5);
                            const tokenData = JSON.parse(atob(base64Token));
                            const now = Date.now() / 1000;
                            const expires = tokenData.expires;
                            
                            if (expires > now) {
                                localStorage.setItem('auth_token', token);
                            }
                        } catch (e) {
                            // Error silencioso en producción
                        }
                    }
                }
            } catch (e) {
                // Error silencioso en producción
            }
        })();
    </script>
    
    <script src="/static/js/patient-dashboard.js"></script>
</body>
</html>