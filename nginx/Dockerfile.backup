# Multi-stage build for Nginx + Frontend assets
FROM node:18-alpine AS frontend-builder

# Set working directory
WORKDIR /app

# Copy frontend assets
COPY fastapi-app/static ./static
COPY fastapi-app/templates ./templates

# Install build tools if needed
RUN apk add --no-cache python3 make g++

# Create package.json for frontend dependencies
RUN cat > package.json << EOF
{
  "name": "fhir-frontend",
  "version": "1.0.0",
  "description": "FHIR Frontend Assets",
  "scripts": {
    "build": "echo 'Frontend assets ready'"
  },
  "dependencies": {
    "bootstrap": "^5.3.2",
    "chart.js": "^3.9.1"
  },
  "devDependencies": {
    "terser": "^5.19.0",
    "clean-css-cli": "^5.6.0"
  }
}
EOF

# Install dependencies
RUN npm install

# Optimize CSS and JS files
RUN npx clean-css-cli -o static/css/main.min.css static/css/main.css || cp static/css/main.css static/css/main.min.css
RUN npx clean-css-cli -o static/css/admin.min.css static/css/admin.css || cp static/css/admin.css static/css/admin.min.css
RUN npx clean-css-cli -o static/css/medic.min.css static/css/medic.css || cp static/css/medic.css static/css/medic.min.css
RUN npx clean-css-cli -o static/css/patient.min.css static/css/patient.css || cp static/css/patient.css static/css/patient.min.css
RUN npx clean-css-cli -o static/css/auditor.min.css static/css/auditor.css || cp static/css/auditor.css static/css/auditor.min.css

RUN npx terser static/js/main.js -o static/js/main.min.js || cp static/js/main.js static/js/main.min.js

# Production Nginx stage
FROM nginx:1.24-alpine

# Install additional packages
RUN apk add --no-cache \
    curl \
    tzdata \
    bash

# Set timezone
ENV TZ=America/Bogota
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# Remove default nginx configuration
RUN rm /etc/nginx/nginx.conf
RUN rm -rf /usr/share/nginx/html/*

# Copy optimized static assets from builder
COPY --from=frontend-builder /app/static /usr/share/nginx/html/static

# Copy Nginx configuration
COPY nginx/nginx.conf /etc/nginx/nginx.conf

# Copy additional Nginx configurations
COPY nginx/conf.d/ /etc/nginx/conf.d/ 2>/dev/null || true

# Create necessary directories
RUN mkdir -p /var/cache/nginx/client_temp \
             /var/cache/nginx/proxy_temp \
             /var/cache/nginx/fastcgi_temp \
             /var/cache/nginx/uwsgi_temp \
             /var/cache/nginx/scgi_temp

# Set permissions
RUN chown -R nginx:nginx /var/cache/nginx \
    && chown -R nginx:nginx /usr/share/nginx/html \
    && chown -R nginx:nginx /var/log/nginx

# Create a simple index.html for health checks
RUN cat > /usr/share/nginx/html/index.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>FHIR System - Loading...</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container { text-align: center; }
        .spinner { 
            border: 4px solid rgba(255,255,255,0.3); 
            border-top: 4px solid white; 
            border-radius: 50%; 
            width: 40px; 
            height: 40px; 
            animation: spin 1s linear infinite; 
            margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h2>Sistema FHIR Distribuido</h2>
        <p>Cargando aplicación...</p>
        <small>Si esta página persiste, verifique que FastAPI esté ejecutándose</small>
    </div>
    <script>
        // Redirect to FastAPI after 3 seconds if it is a direct access
        setTimeout(() => {
            if (window.location.pathname === "/" || window.location.pathname === "/index.html") {
                window.location.href = "/login";
            }
        }, 3000);
    </script>
</body>
</html>
EOF

# Health check script
RUN echo '#!/bin/bash
set -e

# Check if Nginx is running
if ! pgrep nginx > /dev/null; then
    echo "Nginx is not running"
    exit 1
fi

# Check if Nginx is responding
if ! curl -f http://localhost/health > /dev/null 2>&1; then
    echo "Nginx health check failed"
    exit 1
fi

echo "Nginx is healthy"
exit 0
' > /usr/local/bin/health-check.sh && chmod +x /usr/local/bin/health-check.sh

# Startup script
RUN echo '#!/bin/bash
set -e

echo "Starting FHIR Frontend Nginx Server..."
echo "Configuration test..."
nginx -t

echo "Starting Nginx..."
exec nginx -g "daemon off;"
' > /usr/local/bin/start-nginx.sh && chmod +x /usr/local/bin/start-nginx.sh

# Switch to non-root user for security
USER nginx

# Expose port
EXPOSE 80

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD /usr/local/bin/health-check.sh

# Labels for metadata
LABEL maintainer="FHIR System Team" \
      version="1.0.0" \
      description="Nginx frontend for FHIR distributed system" \
      org.opencontainers.image.title="FHIR Nginx Frontend" \
      org.opencontainers.image.description="Production-ready Nginx server for FHIR system frontend" \
      org.opencontainers.image.vendor="FHIR System" \
      org.opencontainers.image.version="1.0.0"

# Start Nginx
CMD ["/usr/local/bin/start-nginx.sh"]