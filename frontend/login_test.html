<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Login Test</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;max-width:480px;margin:40px auto}
    label{display:block;margin-top:12px}
    input{width:100%;padding:8px;margin-top:4px}
    button{margin-top:16px;padding:10px 16px}
    .info{margin-top:12px;color:#444}
  </style>
</head>
<body>
  <h2>Prueba de login</h2>

  <form id="loginForm">
    <label>Usuario
      <input id="username" name="username" type="text" value="admin1" required />
    </label>
    <label>Contraseña
      <input id="password" name="password" type="password" value="secret" required />
    </label>
    <button type="submit">Iniciar sesión</button>
  </form>

  <div class="info" id="result"></div>

  <script>
    const form = document.getElementById('loginForm')
    const result = document.getElementById('result')
    form.addEventListener('submit', async (e)=>{
      e.preventDefault()
      result.textContent = 'Enviando...'
      const data = new URLSearchParams()
      data.append('username', document.getElementById('username').value)
      data.append('password', document.getElementById('password').value)

      try{
        const resp = await fetch('/api/auth/token', {
          method: 'POST',
          body: data,
          headers: { 'Accept': 'application/json' }
        })
        if(!resp.ok){
          const t = await resp.text();
          result.textContent = 'Error: ' + resp.status + ' ' + t
          return
        }
        const body = await resp.json()
        const token = body.access_token
        localStorage.setItem('api_token', token)
        result.textContent = 'Login OK — token almacenado en localStorage. Redirigiendo...'
        setTimeout(()=> location.href = '/api/test/muestra', 800)
      }catch(err){
        result.textContent = 'Error de red: ' + err
      }
    })
  </script>
</body>
</html>
