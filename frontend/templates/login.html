<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login</title>
    <!-- Usamos el css base para coherencia visual -->
    <link rel="stylesheet" href="{{ url_for('static', path='css/base.css') }}" />
    <style>
      /* Estilos específicos mínimos para el formulario de login */
      .login-page{display:flex;align-items:center;justify-content:center;min-height:80vh}
      .login-card{background:#fff;padding:2rem;border-radius:8px;box-shadow:0 6px 18px rgba(16,24,40,0.08);width:360px}
      .login-card h2{margin:0 0 0.5rem;text-align:center}
      .form-group{margin-bottom:0.75rem}
      label{display:block;font-size:0.9rem;margin-bottom:0.25rem}
      input[type="text"], input[type="password"]{width:100%;padding:0.5rem;border:1px solid #e6e9ef;border-radius:4px}
      button[type="submit"]{width:100%;padding:0.6rem;background:var(--accent,#0b74de);color:#fff;border:0;border-radius:6px;font-weight:600;cursor:pointer}
      .muted{text-align:center;color:var(--muted);font-size:0.9rem;margin-top:0.75rem}
    </style>
  </head>
  <body>
    <main class="login-page">
      <div class="login-card">
        <h2>Iniciar sesión</h2>
        <form id="loginForm" method="post" action="/api/auth/login">
          <div class="form-group">
            <label for="username">Documento / Usuario</label>
            <input id="username" name="username" type="text" required placeholder="Documento o usuario" />
          </div>
          <div class="form-group">
            <label for="password">Contraseña</label>
            <input id="password" name="password" type="password" required placeholder="Contraseña" />
          </div>
          <div class="form-group">
            <button type="submit">Entrar</button>
          </div>
          <div class="muted">¿Problemas para entrar? Contacta con el administrador.</div>
        </form>
      </div>
    </main>

    <script src="{{ url_for('static', path='js/auth.js') }}"></script>
    <script>
      // Usar el helper Auth para login y redirección por role.
      document.addEventListener('DOMContentLoaded', function(){
        var form = document.getElementById('loginForm');
        form.addEventListener('submit', function(e){
          e.preventDefault();
          var data = new FormData(form);
          var payload = {};
          data.forEach(function(value, key){ payload[key] = value; });

          // Llamar a Auth.login y redirigir según role devuelto
          Auth.login(form.action, payload).then(function(res){
            // Preferir el role devuelto por el endpoint; si no existe, usar el role almacenado
            var role = (res && res.role) ? res.role : Auth.getRole();
            var dest = Auth.roleToPage(role) || '/dashboard';
            window.location.href = dest;
          }).catch(function(err){
            console.error('login error', err);
            alert((err && err.detail) ? err.detail : 'Error al iniciar sesión');
          });
        });
      });
    </script>
  </body>
</html>
