{% extends 'templates/base.html' %}

{% block title %}Paciente - {{ title if title is defined else 'Paciente' }}{% endblock %}

{% block head %}
  <link rel="stylesheet" href="{{ url_for('static', path='dashboards/patient/css/patient.css') }}" />
{% endblock %}

{% block content %}
  <div class="layout">
    <aside class="sidebar" id="patient-sidebar">
      <div class="sidebar-header">
        <div class="role-emoji">ğŸ§‘â€âš•ï¸</div>
        <div>
          <div class="role-title">Paciente</div>
          <div class="lead small" id="sidebar-username">â€”</div>
        </div>
      </div>

      <nav class="nav-list">
        <button class="nav-item active" data-section="dashboard" onclick="PatientDashboard.navigateTo('dashboard')">Inicio</button>
        <button class="nav-item" data-section="appointments" onclick="PatientDashboard.navigateTo('appointments')">Mis Citas</button>
        <button class="nav-item" data-section="medications" onclick="PatientDashboard.navigateTo('medications')">Medicamentos</button>
        <button class="nav-item" data-section="allergies" onclick="PatientDashboard.navigateTo('allergies')">Alergias</button>
        <button class="nav-item" data-section="summary" onclick="PatientDashboard.navigateTo('summary')">Resumen MÃ©dico</button>
        <button class="nav-item" data-section="profile" onclick="PatientDashboard.navigateTo('profile')">Mi Perfil</button>
        <hr />
        <button class="nav-item" onclick="Auth.logout()">Cerrar sesiÃ³n</button>
      </nav>
    </aside>

    <main class="main-content">
      <!-- Contenedor global para mensajes/alertas (success/error) -->
      <div id="patient-global-message" role="status" aria-live="polite" style="display:none; margin-bottom:1rem;"></div>

      <section id="panel-dashboard">
        <div class="role-header">
          <div class="role-emoji">ğŸ§‘â€âš•ï¸</div>
          <div>
            <div class="role-title"> <span class="badge" data-tooltip="InformaciÃ³n personal">Paciente</span></div>
            <div class="lead">InformaciÃ³n personal y prÃ³ximas citas.</div>
          </div>
        </div>

        <!-- Botones principales removidos segÃºn especificaciÃ³n del cliente -->

        <section class="cards">
    <div class="card">
      <h3>ğŸ“… PrÃ³xima cita</h3>
      <p class="metric" data-field="next_appointment" id="next-appointment">{{ next_appointment if next_appointment is defined else 'â€”' }}</p>
      <button onclick="PatientDashboard.loadAppointments()" class="btn-secondary">Ver todas</button>
    </div>
    <div class="card">
      <h3>â¤ï¸ Estado</h3>
      <p class="metric" data-field="status" id="status">{{ status if status is defined else 'â€”' }}</p>
    </div>
    <div class="card">
      <h3>ğŸ’Š Medicamentos</h3>
      <p class="metric" id="medications-count">â€”</p>
      <button onclick="PatientDashboard.loadMedications()" class="btn-secondary">Ver lista</button>
    </div>
    <div class="card">
      <h3>âš ï¸ Alergias</h3>
      <p class="metric" id="allergies-count">â€”</p>
      <button onclick="PatientDashboard.loadAllergies()" class="btn-secondary">Ver lista</button>
    </div>
  </section>

  <!-- SecciÃ³n de citas -->
  <section id="appointments-section" style="margin-top: 2rem;">
    <h2>Mis Citas</h2>
    <div style="display:flex; align-items:center; gap:1rem; margin-bottom: 1rem;">
      <div>
        <button onclick="PatientDashboard.showCreateAppointmentForm()" class="btn-primary">â• Agendar Cita</button>
      </div>
      <div>
        <label style="display:flex; align-items:center; gap:0.5rem;">
          <input type="checkbox" id="toggle-show-all-appointments" onchange="PatientDashboard.toggleShowAllAppointments(this.checked)"> Mostrar todas
        </label>
      </div>
      <div style="margin-left:auto; font-size:0.9rem; color:var(--muted);">Mostrando: <span id="appointments-filter-label">Pendientes</span></div>
    </div>
    <div id="appointments-list"></div>
  </section>

  <!-- SecciÃ³n de medicamentos -->
  <section id="medications-section" style="display:none; margin-top: 2rem;">
    <h2>Mis Medicamentos</h2>
    <div id="medications-list"></div>
  </section>

  <!-- SecciÃ³n de alergias -->
  <section id="allergies-section" style="display:none; margin-top: 2rem;">
    <h2>Mis Alergias</h2>
    <div id="allergies-list"></div>
  </section>

  <!-- Modal para crear cita -->
  <div id="create-appointment-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:white; margin:5% auto; padding:2rem; width:90%; max-width:500px; border-radius:8px;">
      <h3>Agendar Nueva Cita</h3>
      <form id="create-appointment-form">
        <div style="margin-bottom:1rem;">
          <label>Fecha y Hora:</label>
          <input type="datetime-local" name="fecha_hora" id="create-appointment-fecha" required style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:1rem;">
          <label>DuraciÃ³n (minutos):</label>
          <input type="number" name="duracion_minutos" value="30" min="15" step="15" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;">
        </div>
        <div style="margin-bottom:1rem;">
          <label>MÃ©dico</label>
          <select name="profesional_id" id="practitioner-select" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;">
            <option value="">-- Seleccionar mÃ©dico (opcional) --</option>
          </select>
        </div>
        <div style="margin-bottom:1rem;">
          <label>Motivo:</label>
          <textarea name="motivo" rows="3" style="width:100%; padding:0.5rem; border:1px solid #ccc; border-radius:4px;"></textarea>
        </div>
        <div id="create-appointment-message" role="alert" style="display:none; margin-bottom:1rem; padding:0.6rem 0.8rem; border-radius:6px; font-size:0.95rem; line-height:1.2;"></div>
        <div style="display:flex; gap:1rem;">
          <button type="submit" class="btn-primary">Agendar</button>
          <button type="button" onclick="PatientDashboard.hideCreateAppointmentForm()" class="btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

      <!-- SecciÃ³n Resumen (oculta por defecto) -->
      <section id="summary-section" style="display:none; margin-top:2rem;">
        <h2>Resumen MÃ©dico</h2>
        <div id="summary-content">Cargando...</div>
        <div style="margin-top:1rem;"><button onclick="PatientDashboard.exportSummary('pdf')" class="btn-primary">Descargar PDF</button>
        <button onclick="PatientDashboard.exportSummary('fhir')" class="btn-secondary">Exportar FHIR</button></div>
      </section>

      <!-- SecciÃ³n Perfil -->
      <section id="profile-section" style="display:none; margin-top:2rem;">
        <h2>Mi Perfil</h2>
        <div id="profile-content">Cargando...</div>
      </section>

    </main>
  </div>

{% endblock %}

{% block scripts %}
  <script>window.EXPECTED_ROLE = 'patient';</script>
  <script src="{{ url_for('static', path='js/auth.js') }}"></script>
  <script src="{{ url_for('static', path='js/dashboard.js') }}"></script>
  <script src="{{ url_for('static', path='dashboards/patient/js/patient.js') }}"></script>
{% endblock %}
