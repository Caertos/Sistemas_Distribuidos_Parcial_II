apiVersion: v1
kind: ConfigMap
metadata:
  name: data-init-scripts
  labels:
    app: citus-data-init
data:
  llenar.sh: |
    #!/bin/bash
    echo "üöÄ Iniciando poblado de datos FHIR en Kubernetes..."
    
    # Configuraci√≥n de conexi√≥n
    export PGHOST=citus-coordinator
    export PGPORT=5432
    export PGUSER=postgres
    export PGPASSWORD=postgres
    export PGDATABASE=hce_distribuida
    
    # Funci√≥n para ejecutar SQL
    execute_sql() {
        local sql="$1"
        local description="$2"
        echo "üìù $description"
        psql -v ON_ERROR_STOP=1 -c "$sql" || {
            echo "‚ùå Error ejecutando: $description"
            exit 1
        }
        echo "‚úÖ Completado: $description"
    }
    
    # Verificar conexi√≥n
    echo "üîç Verificando conexi√≥n a base de datos..."
    psql -c "SELECT version();" || {
        echo "‚ùå No se puede conectar a la base de datos"
        exit 1
    }
    
    echo "‚úÖ Conexi√≥n establecida exitosamente"
    echo ""
    
    # Poblar datos b√°sicos
    execute_sql "
    INSERT INTO paciente (documento_id, nombre, apellido, sexo, fecha_nacimiento, contacto, ciudad) VALUES
    ('1001234567', 'Mar√≠a', 'Garc√≠a', 'F', '1985-03-15', '3001234567', 'Bogot√°'),
    ('1002345678', 'Juan', 'P√©rez', 'M', '1990-07-22', '3012345678', 'Medell√≠n'),
    ('1003456789', 'Ana', 'L√≥pez', 'F', '1978-11-05', '3023456789', 'Cali'),
    ('1004567890', 'Carlos', 'Rodr√≠guez', 'M', '1982-01-30', '3034567890', 'Barranquilla'),
    ('1005678901', 'Laura', 'Mart√≠nez', 'F', '1995-09-12', '3045678901', 'Cartagena')
    ON CONFLICT (documento_id) DO NOTHING;
    " "Insertando pacientes de prueba"
    
    execute_sql "
    INSERT INTO profesional (nombre, apellido, especialidad, registro_medico) VALUES
    ('Juan', 'Garc√≠a', 'Medicina General', 'MG-2024-001'),
    ('Mar√≠a', 'L√≥pez', 'Pediatr√≠a', 'PED-2024-002'),
    ('Carlos', 'Rodr√≠guez', 'Cardiolog√≠a', 'CAR-2024-003'),
    ('Ana', 'Mart√≠nez', 'Neurolog√≠a', 'NEU-2024-004'),
    ('Luis', 'Hern√°ndez', 'Traumatolog√≠a', 'TRA-2024-005')
    ON CONFLICT (registro_medico) DO NOTHING;
    " "Insertando profesionales de salud"
    
    # Vincular pacientes con usuarios existentes
    execute_sql "
    UPDATE users SET fhir_patient_id = '2' WHERE username = 'paciente';
    UPDATE users SET fhir_practitioner_id = '1' WHERE username = 'medico';
    " "Vinculando usuarios con entidades FHIR"
    
    # Crear encuentros m√©dicos
    execute_sql "
    INSERT INTO encuentro (documento_id, paciente_id, profesional_id, fecha, motivo, diagnostico) VALUES
    ('1002345678', 2, 1, '2024-11-01', 'Control rutinario', 'Paciente en buen estado general'),
    ('1002345678', 2, 2, '2024-10-15', 'Consulta por cefalea', 'Cefalea tensional'),
    ('1002345678', 2, 3, '2024-09-20', 'Evaluaci√≥n cardiovascular', 'Hipertensi√≥n arterial leve')
    ON CONFLICT DO NOTHING;
    " "Creando encuentros m√©dicos"
    
    # Crear medicamentos
    execute_sql "
    INSERT INTO medicamento (documento_id, paciente_id, nombre_medicamento, dosis, via_administracion, frecuencia, fecha_inicio, fecha_fin, prescriptor_id, estado) VALUES
    ('1002345678', 2, 'Paracetamol', '500mg', 'Oral', 'Cada 8 horas', '2024-11-01', '2024-11-08', 1, 'activo'),
    ('1002345678', 2, 'Ibuprofeno', '400mg', 'Oral', 'Cada 12 horas', '2024-10-15', '2024-10-25', 2, 'completado'),
    ('1002345678', 2, 'Losart√°n', '50mg', 'Oral', 'Una vez al d√≠a', '2024-09-20', '2025-09-20', 3, 'activo')
    ON CONFLICT DO NOTHING;
    " "Creando prescripciones m√©dicas"
    
    # Crear observaciones
    execute_sql "
    INSERT INTO observacion (documento_id, paciente_id, profesional_id, codigo_observacion, valor_cantidad, unidad, fecha_observacion) VALUES
    ('1002345678', 2, 1, 'peso', 70.5, 'kg', '2024-11-01'),
    ('1002345678', 2, 1, 'talla', 1.70, 'm', '2024-11-01'),
    ('1002345678', 2, 3, 'presion_sistolica', 140, 'mmHg', '2024-09-20'),
    ('1002345678', 2, 3, 'presion_diastolica', 90, 'mmHg', '2024-09-20')
    ON CONFLICT DO NOTHING;
    " "Creando observaciones cl√≠nicas"
    
    # Crear alergias
    execute_sql "
    INSERT INTO alergia_intolerancia (documento_id, paciente_id, descripcion_sustancia, severidad, manifestacion, estado) VALUES
    ('1002345678', 2, 'Penicilina', 'severa', 'Rash cut√°neo', 'activa'),
    ('1002345678', 2, 'Polen', 'moderada', 'Rinitis', 'activa')
    ON CONFLICT DO NOTHING;
    " "Creando alergias e intolerancias"
    
    echo ""
    echo "üéâ ¬°Datos de prueba insertados exitosamente!"
    echo "üìä Resumen de datos creados:"
    
    # Mostrar resumen
    echo "üë• Pacientes:"
    psql -c "SELECT COUNT(*) as total_pacientes FROM paciente;"
    
    echo "üë©‚Äç‚öïÔ∏è Profesionales:"
    psql -c "SELECT COUNT(*) as total_profesionales FROM profesional;"
    
    echo "üè• Encuentros:"
    psql -c "SELECT COUNT(*) as total_encuentros FROM encuentro;"
    
    echo "üíä Medicamentos:"
    psql -c "SELECT COUNT(*) as total_medicamentos FROM medicamento;"
    
    echo "üìã Observaciones:"
    psql -c "SELECT COUNT(*) as total_observaciones FROM observacion;"
    
    echo "üö® Alergias:"
    psql -c "SELECT COUNT(*) as total_alergias FROM alergia_intolerancia;"
    
    echo ""
    echo "‚úÖ Proceso de poblado completado exitosamente"
---
apiVersion: batch/v1
kind: Job
metadata:
  name: data-population-job
  labels:
    app: data-population
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      initContainers:
      - name: wait-for-citus
        image: busybox:1.35
        command: ['sh', '-c']
        args:
        - |
          echo "Esperando a que Citus est√© disponible..."
          until nc -z citus-coordinator 5432; do
            echo "Citus no disponible, esperando..."
            sleep 10
          done
          echo "Citus est√° disponible!"
          sleep 30
      containers:
      - name: data-populator
        image: postgres:15-alpine
        env:
        - name: PGHOST
          value: "citus-coordinator"
        - name: PGPORT
          value: "5432"
        - name: PGUSER
          value: "postgres"
        - name: PGPASSWORD
          valueFrom:
            secretKeyRef:
              name: citus-secret
              key: postgres-password
        - name: PGDATABASE
          value: "hce_distribuida"
        command: ["/bin/sh"]
        args: ["/scripts/llenar.sh"]
        volumeMounts:
        - name: scripts
          mountPath: /scripts
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "200m"
      volumes:
      - name: scripts
        configMap:
          name: data-init-scripts
          defaultMode: 0755